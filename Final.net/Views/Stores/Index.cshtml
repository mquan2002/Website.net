@{
    ViewData["Title"] = "Danh sách cửa hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h1>@ViewData["Title"]</h1>

<table class="table">
    <thead>
        <tr>
            <th>Tên cửa hàng</th>
            <th>Địa chỉ</th>
            <th>Mô tả</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var store in Model)
        {
            <tr>
                <td>@store.Name</td>
                <td>@store.Address</td>
                <td>@store.Description</td>
            </tr>
        }
    </tbody>
</table>

<!-- Container for map -->
<div style="position: relative; height: 80vh; margin-bottom: 50px;">
    <div id="map" style="height: 80vh; width: 100%; border-radius: 10px;"></div>
</div>

<!-- Leaflet.js CSS và JavaScript -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    var stores = [];
    // Lấy thông tin cửa hàng từ API
    fetch('/api/stores')
        .then(response => {
            if (!response.ok) {
                throw new Error('API Error: ' + response.status);
            }
            return response.text(); // Đọc phản hồi như văn bản
        })
        .then(data => {
            try {
                const stores = JSON.parse(data);  // Chuyển đổi thành JSON
                if (!stores || stores.length === 0) {
                    console.log('Không có cửa hàng.');
                    return; // Nếu không có cửa hàng, dừng lại
                }
                initMap(stores); // Tiến hành hiển thị bản đồ
            } catch (error) {
                console.error('Lỗi phân tích JSON:', error);
            }
        })
        .catch(error => {
            console.error('Lỗi khi lấy dữ liệu:', error);
        });


    function initMap(stores) {
        var map = L.map('map').setView([10.762622, 106.660172], 12); // Vị trí mặc định (Hồ Chí Minh)

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        stores.forEach(function (store) {
            if (store.latitude && store.longitude) {
                var marker = L.marker([store.latitude, store.longitude]).addTo(map);
                marker.bindPopup(`<h3>${store.name}</h3><p>${store.address}</p><p>${store.description}</p>`);
            } else {
                console.warn(`Cửa hàng "${store.name}" không có tọa độ hợp lệ.`);
            }
        });
    }

</script>
